<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinamik Chart Uygulaması</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <h1>Dinamik Chart Uygulaması</h1>

    <!-- Veritabanı Bağlantı Bilgileri -->
    <div>
        <label for="dbType">Veritabanı Türü:</label>
        <select id="dbType">
            <option value="sqlserver">SqlServer</option>
            <option value="mysql">MySQL</option>
            <option value="postgresql">PostgreSQL</option>
        </select>
    </div>
    <div>
        <label for="server">Sunucu:</label>
        <input type="text" id="server" placeholder="localhost">
    </div>
    <div>
        <label for="database">Veritabanı Adı:</label>
        <input type="text" id="database" placeholder="Veritabanı Adı">
    </div>
    <div>
        <label for="userId">Kullanıcı Adı:</label>
        <input type="text" id="userId" placeholder="Kullanıcı Adı">
    </div>
    <div>
        <label for="password">Şifre:</label>
        <input type="password" id="password" placeholder="Şifre">
    </div>
    <button onclick="connectDatabase()">Bağlan ve Tabloları Getir</button>

    <!-- Bağlantı durumu mesajı -->
    <div id="message"></div>

    <!-- Tablo ve Sütun Seçimi -->
    <h2>Tablo ve Sütun Seçimi</h2>
    <div>
        <label for="tableSelect">Tablo Seçin:</label>
        <select id="tableSelect">
            <option value="">Tablo Seçin</option>
        </select>
    </div>
    <div>
        <label for="columnSelect">Sütun Seçin:</label>
        <select id="columnSelect">
            <option value="">Sütun Seçin</option>
        </select>
    </div>

    <!-- Farklı tablo ile ilişkilendirme checkbox -->
    <div>
        <input type="checkbox" id="enableJoin" onclick="toggleJoinFields()">
        <label for="enableJoin">Farklı tablo ile ilişkilendireceğim</label>
    </div>

    <!-- Birleştirilecek tablo ve sütunlar -->
    <div>
        <label for="joinTableSelect">Birleştirilecek Tablo:</label>
        <input type="text" id="joinTableSelect" placeholder="Birleştirilecek Tablo" disabled>
    </div>
    <div>
        <label for="joinColumnSelect">Birleştirilecek Sütun:</label>
        <input type="text" id="joinColumnSelect" placeholder="Birleştirilecek Sütun" disabled>
    </div>
    <div>
        <label for="displayColumnSelect">Görüntülenecek Sütun:</label>
        <input type="text" id="displayColumnSelect" placeholder="Görüntülenecek Sütun" disabled>
    </div>

    <!-- Grafik Türü Seçimi -->
    <div>
        <label for="chartTypeSelect">Grafik Türü Seçin:</label>
        <select id="chartTypeSelect">
            <option value="bar">Bar Chart</option>
            <option value="line">Line Chart</option>
            <option value="radar">Radar Chart</option>
        </select>
    </div>

    <button onclick="handleButtonClick()">Veriyi Getir ve Grafiği Göster</button>

    <canvas id="myChart" width="400" height="200"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let myChart = null;

        function handleButtonClick() {
            const isJoinEnabled = document.getElementById('enableJoin').checked;

            if (isJoinEnabled) {
                fetchColumnValueCountsWithJoin();
            } else {
                fetchColumnValueCounts();
            }
        }

        function toggleJoinFields() {
            const isChecked = document.getElementById('enableJoin').checked;
            document.getElementById('joinTableSelect').disabled = !isChecked;
            document.getElementById('joinColumnSelect').disabled = !isChecked;
            document.getElementById('displayColumnSelect').disabled = !isChecked;
        }

        function connectDatabase() {
            const dbType = document.getElementById('dbType').value;
            const server = document.getElementById('server').value;
            const database = document.getElementById('database').value;
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;

            const connectionRequest = {
                DatabaseType: dbType,
                ServerName: server,
                DatabaseName: database,
                Username: userId,
                Password: password
            };

            fetch('https://localhost:7249/api/ConnectionString/SetConnection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connectionRequest)
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('message').innerText = data.message;
                    if (data.success) {
                        fetchTables();
                    }
                })
                .catch(error => {
                    document.getElementById('message').innerText = `Bağlantı hatası: ${error.message}`;
                });
        }

        function fetchTables() {
            fetch('https://localhost:7249/api/Data/GetTables')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(tables => {
                    const tableSelect = document.getElementById('tableSelect');
                    tableSelect.innerHTML = '<option value="">Tablo Seçin</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        tableSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching tables:', error));
        }

        function fetchColumns() {
            const table = document.getElementById('tableSelect').value;
            if (!table) {
                alert("Lütfen bir tablo seçin.");
                return;
            }

            fetch(`https://localhost:7249/api/Data/GetColumns?tableName=${table}`)
                .then(response => response.json())
                .then(columns => {
                    const columnSelect = document.getElementById('columnSelect');
                    columnSelect.innerHTML = '<option value="">Sütun Seçin</option>';
                    columns.forEach(column => {
                        const option = document.createElement('option');
                        option.value = column;
                        option.textContent = column;
                        columnSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching columns:', error));
        }

        function drawChart(chartType, labels, counts, displayColumn) {
            const ctx = document.getElementById('myChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Quantity - ${displayColumn}`,
                        data: counts,
                        backgroundColor: chartType === 'radar' ? 'rgba(54, 162, 235, 0.2)' : chartType === 'bar' ? 'rgba(54, 162, 235, 0.2)' : 'rgba(54, 162, 235, 0)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        fill: chartType === 'line' || chartType === 'radar' ? true : false
                    }]
                },
                options: {
                    scales: chartType === 'radar' ? {} : {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function fetchColumnValueCountsWithJoin() {
            const table = document.getElementById('tableSelect').value;
            const column = document.getElementById('columnSelect').value;
            const joinTable = document.getElementById('joinTableSelect').value;
            const joinColumn = document.getElementById('joinColumnSelect').value;
            const displayColumn = document.getElementById('displayColumnSelect').value;
            const chartType = document.getElementById('chartTypeSelect').value;

            if (!table || !column || !joinTable || !joinColumn || !displayColumn) {
                alert("Lütfen gerekli tüm alanları doldurun.");
                return;
            }

            fetch(`https://localhost:7249/api/Data/GetColumnValueCountsWithJoin?tableName=${table}&columnName=${column}&joinTable=${joinTable}&joinColumn=${joinColumn}&displayColumn=${displayColumn}`)
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(item => item[displayColumn]);
                    const counts = data.map(item => item.Count);
                    drawChart(chartType, labels, counts, displayColumn);
                })
                .catch(error => console.error('Error fetching column value counts with join:', error));
        }

        function fetchColumnValueCounts() {
            const table = document.getElementById('tableSelect').value;
            const column = document.getElementById('columnSelect').value;
            const chartType = document.getElementById('chartTypeSelect').value;

            if (!table || !column) {
                alert("Lütfen tabloyu ve sütunu seçin.");
                return;
            }

            fetch(`https://localhost:7249/api/Data/GetColumnValueCounts?tableName=${table}&columnName=${column}`)
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(item => item[column]);
                    const counts = data.map(item => item.Count);
                    drawChart(chartType, labels, counts, column);
                })
                .catch(error => console.error('Error fetching column value counts:', error));
        }//

        document.getElementById('tableSelect').addEventListener('change', fetchColumns);
    </script>
</body>
</html>
